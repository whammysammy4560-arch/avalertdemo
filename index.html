<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>AvAlert UI</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
:root{
  --footerH:52px;
  --radius:14px;

  --stable:#26c281;
  --variable:#f6a623;
  --unstable:#ff4d4f;

  /* defaults; overridden by theme */
  --bg:#0b0f14; --panel:#0f1620; --panel-2:#111b27;
  --text:#e8f0f7; --muted:#9fb3c8; --accent:#78d3ff;
}

/* Frame */
*{box-sizing:border-box;}
body{
  margin:0;background:#0b0f14;color:var(--text);
  display:flex;justify-content:center;padding:24px;font-family:'Inter',sans-serif;
}
.device{
  width:320px;height:240px;border-radius:var(--radius);
  border:1px solid #243245;overflow:hidden;position:relative;
  background:var(--bg);color:var(--text);
  box-shadow:0 14px 34px rgba(0,0,0,.45);
}

/* Splash */
.splash{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  background:var(--bg);z-index:9999;animation:fadeOut 1.2s ease 1.1s forwards;
}
.splash-inner{display:flex;flex-direction:column;align-items:center;gap:8px}
.splash-title{font-family:"Archivo Black";font-size:20px;letter-spacing:.6px}
.snow{
  width:26px;height:26px;animation:spin 1.1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeOut{to{opacity:0;visibility:hidden}}

/* Themes (existing) */
.device[data-theme="glacier"] {--bg:#0b0f14;--panel:#0f1620;--panel-2:#111b27;--text:#e8f0f7;--muted:#9fb3c8;--accent:#78d3ff;}
.device[data-theme="alpine"]  {--bg:#005f9e;--panel:#004d7e;--panel-2:#003b60;--text:#ffffff;--muted:#d7ecff;--accent:#b6e9ff;}
.device[data-theme="whiteout"]{--bg:#fafcff;--panel:#e9eef5;--panel-2:#e2e8f0;--text:#0b0f14;--muted:#566677;--accent:#1b6e00;}
.device[data-theme="diamond"] {--bg:#000000;--panel:#111;--panel-2:#181818;--text:#ffffff;--muted:#bdbdbd;--accent:#00ffd0;}

/* Ultra Offroad (Apple Watch Ultra: black bg, orange text) */
.device[data-theme="ultra"]{
  --bg:#000; --panel:#0a0a0a; --panel-2:#111;
  --text:#ff7a00; --muted:#ffb277; --accent:#ff7a00;
}

/* Additional palettes */
.device[data-theme="forest"]  {--bg:#0b1a12; --panel:#0f2419; --panel-2:#12301f; --text:#e8f5ee; --muted:#a7c9b8; --accent:#4be38b;}
.device[data-theme="iceberry"]{--bg:#111325; --panel:#161a33; --panel-2:#1b2040; --text:#ecf2ff; --muted:#b3c0ff; --accent:#46ffd1;}

/* Logo contrast (Ultra/Whiteout/Alpine invert to pop dark logos) */
.device[data-theme="whiteout"] .logo,
.device[data-theme="alpine"] .logo,
.device[data-theme="ultra"]  .logo {filter: invert(1);}
.device[data-theme="glacier"] .logo,
.device[data-theme="diamond"] .logo,
.device[data-theme="forest"]  .logo,
.device[data-theme="iceberry"] .logo {filter: invert(0);}

/* PRO styling */
.device.pro .label{letter-spacing:.1px;}
.device.pro .value{font-weight:700;}
.device.pro canvas{border-color:#3d556d;}

/* Field Mode styling (bigger, simpler) */
.device.field .content{overflow-y:hidden;}
.device.field .big-num{font-family:"Archivo Black";font-size:56px;line-height:1.0;margin-top:4px;}
.device.field .big-unit{font-size:16px;color:var(--muted);margin-top:2px;}
.device.field .big-wrap{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;}

/* Top Bar */
.topbar{
  position:absolute;top:0;left:0;right:0;height:32px;
  background:linear-gradient(180deg,var(--panel),var(--panel-2));
  border-bottom:1px solid #203040;
  display:flex;align-items:center;padding:0 6px;
}
.logo{width:22px;height:22px;margin-right:4px;object-fit:contain;}
.brand{font-family:"Archivo Black";font-size:12px;opacity:.9;margin-right:4px;}
#heading{font-size:12px;opacity:.85;}
.spacer{flex:1;}
#direction{font-size:12px;opacity:.85;margin-right:6px;}
.statusbar{font-size:12px;opacity:.85;}

/* Content & Footer */
.content{
  position:absolute;top:32px;left:0;right:0;
  bottom:calc(var(--footerH) + 6px);
  padding:10px 12px;background:var(--panel-2);color:var(--text);
  overflow-y:auto;
}
.footer{
  position:absolute;left:0;right:0;bottom:0;height:var(--footerH);
  background:var(--panel);border-top:1px solid #203040;
  display:flex;justify-content:space-around;align-items:center;gap:6px;padding:0 6px;
}
.btn{
  background:var(--panel-2);border:1px solid #2b3a4a;color:var(--text);
  padding:6px 9px;border-radius:10px;font-size:12px;cursor:pointer;flex:1;text-align:center;
}

/* Status */
.status-ribbon{
  width:100%;text-align:center;
  padding:6px 0;font-family:'Archivo Black';font-size:14px;
  border-radius:6px;margin-bottom:10px;
}
.stable{background:var(--stable);color:#062718;}
.variable{background:var(--variable);color:#2b1d05;}
.unstable{background:var(--unstable);color:#2b0707;}

.status-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.label{font-size:13px;color:var(--muted);}
.value{font-size:18px;font-weight:600;margin-top:1px;}
.raw{font-size:11px;color:var(--muted);margin-top:7px;line-height:1.3;}

/* PRO Advanced Panel */
.pro-card{
  margin-top:8px;border:1px solid #334357;border-radius:8px;background:rgba(0,0,0,.15);
  padding:8px;
}
.pro-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:4px;}
.kv{font-size:12px;color:var(--muted);}
.kv b{color:var(--text);font-weight:600;}

/* Slope Gauge (G-Compact) */
.slope-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;}
#slopeGauge{width:95px;height:95px;}
.slope-deg{font-family:"Archivo Black";font-size:38px;margin-top:6px;}

/* Trends */
.trends-hscroll{
  display:flex;overflow-x:auto;overflow-y:hidden;
  height:100%;scroll-behavior:smooth;scroll-snap-type:x mandatory;
}
.trend-card{
  flex:0 0 100%;scroll-snap-align:center;padding-right:6px;
}
.trend-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
.trend-label{font-size:13px;color:var(--muted);}
.unit-chips{display:flex;gap:6px;flex-wrap:wrap;}
.chip{
  font-size:11px;border:1px solid #2b3a4a;border-radius:999px;padding:2px 6px;
  background:var(--panel);color:var(--text);cursor:pointer;user-select:none;
}
canvas{
  width:100%;height:70px;display:block;
  border-radius:8px;background:#0b121a;border:1px solid #223040;
}

/* PRO table */
.tr-table-wrap{
  height:120px;overflow-y:auto;border:1px solid #3a4b60;border-radius:8px;background:rgba(0,0,0,.18);
}
.tr-table{width:100%;border-collapse:collapse;font-size:12px;}
.tr-table thead th{
  position:sticky;top:0;z-index:1;background:var(--panel);
  text-align:left;padding:6px;border-bottom:1px solid #3a4b60;
}
.tr-table td{
  padding:4px 6px;border-bottom:1px solid rgba(255,255,255,.22);border-right:1px solid rgba(255,255,255,.22);
}
.tr-table td:last-child{border-right:none;}
.tr-table tbody tr:last-child td{border-bottom:none;}

/* Settings */
.sheet{
  position:absolute;top:32px;left:0;right:0;bottom:var(--footerH);
  padding:14px;display:none;z-index:4;overflow:auto;
  background:color-mix(in srgb, var(--bg) 80%, #000 20%);backdrop-filter:blur(4px);
}
.sheet.open{display:block;}
.closeX{position:absolute;top:8px;right:8px;font-size:16px;cursor:pointer;font-weight:600;opacity:.85;}
.settings-title{font-family:'Archivo Black';font-size:16px;margin:10px 0 6px;}
.theme-row{display:flex;gap:8px;flex-wrap:wrap;}
.swatch{width:26px;height:26px;border-radius:5px;cursor:pointer;border:2px solid #fff2;}
.select,.checkbox{cursor:pointer;}
.pro-blurb{font-size:11px;color:var(--muted);margin:4px 0 10px;}
.small-inline{font-size:11px;color:var(--muted);margin-left:6px;}
.inline-num{
  width:64px;padding:2px 4px;border-radius:6px;border:1px solid #2b3a4a;
  background:var(--panel);color:var(--text);font-size:12px;
}
.download-btn{margin-top:6px;}
</style>
</head>

<body>
<div class="device" id="device" data-theme="glacier">

  <!-- Splash -->
  <div class="splash" id="splash">
    <div class="splash-inner">
      <svg class="snow" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M12 2v20M4.2 5.2l15.6 13.6M4.2 18.8L19.8 5.2M2 12h20" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <div class="splash-title">AvAlert</div>
    </div>
  </div>

  <!-- Top Bar -->
  <div class="topbar">
    <img id="brandLogo" class="logo">
    <div class="brand">AvAlert</div>
    <div id="heading">| Status</div>
    <div class="spacer"></div>
    <div id="direction">NE</div>
    <div class="statusbar">üîã82%</div>
  </div>

  <!-- Content -->
  <div class="content" id="screen"></div>

  <!-- Settings -->
  <div id="settingsSheet" class="sheet">
    <div class="closeX" onclick="toggleSettings(false)">‚úï</div>

    <div class="settings-title">Theme</div>
    <div class="theme-row">
      <div class="swatch" style="background:#0b0f14" onclick="setTheme('glacier')" title="Glacier"></div>
      <div class="swatch" style="background:#005f9e" onclick="setTheme('alpine')" title="Alpine"></div>
      <div class="swatch" style="background:#fafcff;border:1px solid #0003" onclick="setTheme('whiteout')" title="Whiteout"></div>
      <div class="swatch" style="background:#000" onclick="setTheme('diamond')" title="Black Diamond"></div>
      <div class="swatch" style="background:#ff7a00" onclick="setTheme('ultra')" title="Ultra Offroad"></div>
      <div class="swatch" style="background:#12301f" onclick="setTheme('forest')" title="Forest"></div>
      <div class="swatch" style="background:#1b2040" onclick="setTheme('iceberry')" title="Iceberry"></div>
    </div>

    <div class="settings-title">Units ‚Äî Temperature</div>
    <select id="unitsSelect" onchange="saveUnits(this.value)">
      <option value="C">Celsius</option>
      <option value="F">Fahrenheit</option>
    </select>

    <div class="settings-title">Units ‚Äî Depth</div>
    <select id="depthUnits" onchange="saveDepthUnits(this.value)">
      <option value="cm">cm</option>
      <option value="m">m</option>
      <option value="ft">ft</option>
    </select>

    <div class="settings-title">Options</div>
    <label><input type="checkbox" id="proToggle" onchange="savePro()"> PRO Mode</label>
    <div class="pro-blurb">Shows advanced stats (œÉ, MA, min/max), rate arrows, projections, analysis & raw data table, Trends export, quick unit chips, and enables storm override for incoming snowfall.</div>

    <label><input type="checkbox" id="stormToggle" onchange="saveStorm()"> Storm Mode (override)</label>
    <span class="small-inline">Snowfall:</span>
    <input id="stormRate" type="number" class="inline-num" step="0.1" min="0" value="0.0" oninput="saveStormRate(this.value)">
    <span class="small-inline">cm/hr</span>

    <div class="settings-title">Field Mode</div>
    <label><input type="checkbox" id="fieldToggle" onchange="toggleFieldMode()"> Field Mode (large, in-motion UI)</label>
    <div class="pro-blurb">Large, high-contrast single-metric display with simplified controls. Default shows <b>Slope</b>; tap ‚ÄúSwap‚Äù to switch to <b>Depth</b>.</div>

    <button class="btn" style="margin-top:10px;width:100%;" onclick="resetPro()">Reset PRO Settings</button>
  </div>

  <!-- Footer -->
  <div class="footer" id="footer"></div>
</div>

<script>
/* Brand logo ‚Äî Google Drive (must be shared: Anyone with link ‚Üí Viewer) */
const logo = document.getElementById("brandLogo");
logo.src = "https://drive.google.com/uc?export=view&id=1usQeZjAEIsJeXOLOa9XNgZ2WJAcn4aQo";
/* Fallback if Drive link fails */
logo.onerror = () => {
  logo.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 30'><path d='M10 25 L30 5 L50 25 L70 5 L90 25' stroke='white' stroke-width='6' fill='none'/></svg>";
};

/* State */
let state={
  depth:110, trend:1.2, tempC:-3.1, slope:28, aspect:145,
  showArrows:true, pro:false,
  depthSeries:[], tempSeries:[], slopeSeries:[],
  dir:0,
  storm:false, stormRate:0.0, // cm/hr
  field:false, fieldMetric:"slope" // "slope" or "depth"
};
const DIR=["N","NE","E","SE","S","SW","W","NW"];

/* Splash hide after animation completes */
setTimeout(()=>{const s=document.getElementById('splash'); if(s) s.style.display='none';}, 2400);

/* Settings & Theme */
function toggleSettings(x){document.getElementById("settingsSheet").classList.toggle("open",x);}
function setTheme(t){document.getElementById("device").setAttribute("data-theme",t);localStorage.setItem("av_theme",t);}
(function(){setTheme(localStorage.getItem("av_theme")||"glacier");})();

function saveUnits(v){localStorage.setItem("units",v);render();}
function saveDepthUnits(v){localStorage.setItem("depthUnits",v);render();}
function savePro(){state.pro=document.getElementById("proToggle").checked;document.getElementById("device").classList.toggle("pro",state.pro);render();}
function saveArrows(){state.showArrows=document.getElementById("arrowToggle")?.checked ?? state.showArrows;render();}

function toggleFieldMode(){
  state.field=document.getElementById("fieldToggle").checked;
  document.getElementById("device").classList.toggle("field",state.field);
  if(state.field){ setMode('field'); } else { setMode('status'); }
}

/* Storm override */
function saveStorm(){ state.storm=document.getElementById("stormToggle").checked; render(); }
function saveStormRate(val){ state.stormRate=parseFloat(val||"0")||0; render(); }

/* Units helpers (U3 behavior) */
function depthUnitsLabel(){return localStorage.getItem("depthUnits")||"cm";}
function tempUnitsLabel(){return (localStorage.getItem("units")==="F") ? "¬∞F" : "¬∞C";}
function depthDisplay(v){const u=depthUnitsLabel();return u==="m"?(v/100).toFixed(2)+" m":u==="ft"?(v/30.48).toFixed(2)+" ft":v.toFixed(1)+" cm";}
function tempDisplay(){return (localStorage.getItem("units")==="F")?((state.tempC*9/5+32).toFixed(1)+"¬∞F"):(state.tempC.toFixed(1)+"¬∞C");}
function convertDepthForGraph(v){const u=depthUnitsLabel();return u==="m"?v/100:u==="ft"?v/30.48:v;}
function convertTempForGraph(c){return (localStorage.getItem("units")==="F")?(c*9/5+32):c;}

/* Stats helpers */
function mean(a){return a.length? a.reduce((s,x)=>s+x,0)/a.length : 0;}
function stdev(a){if(a.length<2) return 0; const m=mean(a), v=mean(a.map(x=>(x-m)**2)); return Math.sqrt(v);}
function linreg(y){const n=y.length; if(n<2) return {m:0,b:y[n-1]||0}; let sx=0,sy=0,sxx=0,sxy=0; for(let i=0;i<n;i++){sx+=i; sy+=y[i]; sxx+=i*i; sxy+=i*y[i];} const m=(n*sxy - sx*sy)/Math.max(1,(n*sxx - sx*sx)); const b=(sy - m*sx)/n; return {m,b};}
function lastN(arr,n){return arr.slice(-n);}

/* Risk model with Storm override */
function classifyRisk(){
  if(state.slope < 30) return "stable";
  const d=state.trend, s=state.slope, t=state.tempC - (state.tempSeries[state.tempSeries.length-2] ?? state.tempC);
  const stormBoost = state.storm ? state.stormRate : 0; // cm/hr
  const effTrend = d + stormBoost*0.8;

  if(s>35 || effTrend>2.5 || t>0.8) return "unstable";
  if(s>=30 || effTrend>=1.0 || t>=0.3) return "variable";
  return "stable";
}
function slopeClass(){return state.slope<30?"slope-safe":state.slope<35?"slope-warn":"slope-danger";}

/* PRO composite risk score (0-100) */
function riskScore(){
  const slopeTerm = Math.max(0, (state.slope-30)/10);
  const trendTerm = Math.min(1, Math.abs(state.trend)/3);
  const stormTerm = Math.min(1, (state.storm ? state.stormRate/3 : 0));
  const warmTerm  = Math.max(0, (state.tempC - (-1)) / 3);
  const raw = 0.50*slopeTerm + 0.30*Math.max(trendTerm, stormTerm) + 0.20*warmTerm;
  return Math.round(Math.min(100, Math.max(0, raw*100)));
}

/* Mode */
function setMode(m){window.mode=m;document.getElementById("heading").textContent="| "+m[0].toUpperCase()+m.slice(1);render();}

/* Sparklines */
function drawSpark(id, arr){
  const c=document.getElementById(id);if(!c)return;
  c.width=c.clientWidth;c.height=70;
  const g=c.getContext("2d");g.clearRect(0,0,c.width,c.height);
  // grid
  g.strokeStyle="#3b4e63";
  for(let i=1;i<4;i++){const y=i*(c.height/4);g.beginPath();g.moveTo(0,y);g.lineTo(c.width,y);g.stroke();}
  if(arr.length<2)return;
  const vals=arr.slice(-60),min=Math.min(...vals),max=Math.max(...vals),range=(max-min)||1;
  const accent=getComputedStyle(document.getElementById("device")).getPropertyValue("--accent").trim();
  g.strokeStyle=accent;g.beginPath();
  vals.forEach((v,i)=>{const x=(i/(vals.length-1))*c.width,y=c.height-7-((v-min)/range)*(c.height-20);i?g.lineTo(x,y):g.moveTo(x,y);});
  g.stroke();
}

/* Inclinometer (needle color N3) */
function renderGauge(){
  const c=document.getElementById("slopeGauge");if(!c)return;
  const g=c.getContext("2d");c.width=c.clientWidth;c.height=c.clientHeight;
  const cx=c.width/2,cy=c.height/2,r=42;
  g.clearRect(0,0,c.width,c.height);
  g.lineWidth=8;
  g.strokeStyle="#26c281";g.beginPath();g.arc(cx,cy,r,Math.PI*1.1,Math.PI*1.5);g.stroke();
  g.strokeStyle="#f6a623";g.beginPath();g.arc(cx,cy,r,Math.PI*1.5,Math.PI*1.63);g.stroke();
  g.strokeStyle="#ff4d4f";g.beginPath();g.arc(cx,cy,r,Math.PI*1.63,Math.PI*1.9);g.stroke();
  let nc="#26c281";if(state.slope>=30&&state.slope<35)nc="#f6a623";if(state.slope>=35)nc="#ff4d4f";
  const ang = (Math.PI*1.1) + ((state.slope/60)*Math.PI*0.8);
  g.strokeStyle=nc;g.lineWidth=3;g.beginPath();g.moveTo(cx,cy);g.lineTo(cx+Math.cos(ang)*r, cy+Math.sin(ang)*r);g.stroke();
}

/* Strings */
function trendStr(){const a=(state.pro||state.showArrows)?(state.trend>=0?"‚ñ≤":"‚ñº"):"";return `${a} ${state.trend.toFixed(1)} cm/hr`;}
function deltaTempStr(){
  const prev=state.tempSeries[state.tempSeries.length-2]; if(prev===undefined) return "ŒîT: ‚Äî";
  const dC=state.tempC-prev; const isF=(localStorage.getItem("units")==="F"); const d=isF?(dC*9/5):dC;
  return `ŒîT: ${d>=0?"+":""}${d.toFixed(2)} ${isF?"¬∞F":"¬∞C"}`;
}
function deltaSlopeStr(){
  const prev=state.slopeSeries[state.slopeSeries.length-2]; if(prev===undefined) return "ŒîSlope: ‚Äî";
  const ds=state.slope-prev; return `ŒîSlope: ${ds>=0?"+":""}${ds.toFixed(2)}¬∞`;
}

/* CSV Export (last 200 samples) */
function exportCSV(){
  const rows=[["idx","depth_cm","temp_C","slope_deg"]];
  const n=state.depthSeries.length;
  const start=Math.max(0,n-200);
  for(let i=start;i<n;i++){
    const d = state.depthSeries[i]?.toFixed(3) ?? "";
    const t = state.tempSeries[i]?.toFixed(3) ?? "";
    const s = state.slopeSeries[i]?.toFixed(3) ?? "";
    rows.push([i,d,t,s]);
  }
  const csv = rows.map(r=>r.join(",")).join("\n");
  const a=document.createElement("a");
  a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv);
  a.download="avalert_data.csv";
  a.click();
}

/* Field Mode render */
function renderField(){
  const el=document.getElementById("screen");
  const risk=classifyRisk();
  el.className="content";
  const metric = state.fieldMetric; // "slope" or "depth"
  const valStr = metric==="slope" ? `${Math.round(state.slope)}` : depthDisplay(state.depth).split(" ")[0];
  const unitStr = metric==="slope" ? "¬∞" : depthDisplay(state.depth).split(" ")[1];

  el.innerHTML = `
    <div class="status-ribbon ${risk}">${risk==="stable"?"‚úì GO":risk==="variable"?"‚âà CAUTION":"‚ö† NO-GO"}</div>
    <div class="big-wrap">
      <div class="label" style="font-size:13px;color:var(--muted);">${metric==="slope"?"Slope Angle":"Snow Depth"}</div>
      <div class="big-num">${valStr}${metric==="slope"?"¬∞":""}</div>
      ${metric==="depth"?`<div class="big-unit">${unitStr}</div>`:""}
    </div>
  `;
}

/* Standard screen renders */
function renderStatus(){
  const el=document.getElementById("screen");
  const risk=classifyRisk();

  const ma5_d = mean(lastN(state.depthSeries,5));
  const ma15_d= mean(lastN(state.depthSeries,15));
  const tempArr  = lastN(state.tempSeries,60);
  const slopeArr = lastN(state.slopeSeries,60);
  const depthArr = lastN(state.depthSeries,60);

  el.className="content";
  el.innerHTML=`
    <div class="status-ribbon ${risk}">${risk==="stable"?"‚úì STABLE":risk==="variable"?"‚âà VARIABLE":"‚ö† UNSTABLE"}</div>
    <div class="status-grid">
      <div><div class="label">Depth</div><div class="value">${depthDisplay(state.depth)}</div></div>
      <div><div class="label">Air Temp</div><div class="value">${tempDisplay()}</div></div>
      <div><div class="label">Trend</div><div class="value">${trendStr()}</div></div>
      <div><div class="label">Slope</div><div class="value">${Math.round(state.slope)}¬∞</div></div>
    </div>
    ${state.pro?`
      <div class="pro-card">
        <div class="label" style="margin-bottom:4px;">PRO Advanced</div>
        <div class="pro-row">
          <div class="kv">Depth œÉ(30): <b>${stdev(lastN(state.depthSeries,30)).toFixed(2)}</b></div>
          <div class="kv">Temp œÉ(30): <b>${stdev(lastN(state.tempSeries,30)).toFixed(2)}¬∞C</b></div>
          <div class="kv">Slope œÉ(30): <b>${stdev(lastN(state.slopeSeries,30)).toFixed(2)}¬∞</b></div>
          <div class="kv">MA-5/15 Depth: <b>${depthDisplay(ma5_d)} / ${depthDisplay(ma15_d)}</b></div>
          <div class="kv">ŒîT / ŒîSlope: <b>${deltaTempStr().replace('ŒîT: ','')} / ${deltaSlopeStr().replace('ŒîSlope: ','')}</b></div>
          <div class="kv">Depth min/max: <b>${depthDisplay(Math.min(...depthArr))} / ${depthDisplay(Math.max(...depthArr))}</b></div>
          <div class="kv">Temp min/max: <b>${(Math.min(...tempArr)).toFixed(1)}¬∞C / ${(Math.max(...tempArr)).toFixed(1)}¬∞C</b></div>
          <div class="kv">Slope min/max: <b>${Math.min(...slopeArr).toFixed(1)}¬∞ / ${Math.max(...slopeArr).toFixed(1)}¬∞</b></div>
          <div class="kv">Risk Score: <b>${riskScore()} / 100</b></div>
        </div>
      </div>
    `:""}
  `;
}

function renderSlope(){
  const el=document.getElementById("screen");
  el.className="content "+slopeClass();
  el.innerHTML=`<div class="slope-screen">
    <canvas id="slopeGauge"></canvas>
    <div class="slope-deg">${Math.round(state.slope)}¬∞</div>
  </div>`;
  renderGauge();
}

function unitChip(label, onClick){
  return `<span class="chip" onclick="${onClick}">${label}</span>`;
}

function renderTrends(){
  const el=document.getElementById("screen");
  const depthUnit=depthUnitsLabel(),tempU=tempUnitsLabel();

  const projD = linreg(lastN(state.depthSeries,20));
  const projT = linreg(lastN(state.tempSeries,20));
  const nextDepth = projD.m*10 + projD.b;
  const nextTempC = projT.m*10 + projT.b;

  el.className="content";
  el.innerHTML=`
    <div class="trend-label">Swipe ‚Üí</div>
    <div class="trends-hscroll">
      <div class="trend-card">
        <div class="trend-header">
          <div class="trend-label">Depth (${depthUnit})</div>
          <div class="unit-chips">
            ${unitChip("cm","saveDepthUnits('cm')")}
            ${unitChip("m","saveDepthUnits('m')")}
            ${unitChip("ft","saveDepthUnits('ft')")}
          </div>
        </div>
        <canvas id="c1"></canvas>
      </div>

      <div class="trend-card">
        <div class="trend-header">
          <div class="trend-label">Temp (${tempU})</div>
          <div class="unit-chips">
            ${unitChip("¬∞C","saveUnits('C')")}
            ${unitChip("¬∞F","saveUnits('F')")}
          </div>
        </div>
        <canvas id="c2"></canvas>
      </div>

      <div class="trend-card">
        <div class="trend-header">
          <div class="trend-label">Slope (¬∞)</div>
          <div class="unit-chips">
            ${unitChip("Export CSV","exportCSV()")}
          </div>
        </div>
        <canvas id="c3"></canvas>
      </div>

      ${state.pro?`
      <div class="trend-card">
        <div class="trend-label">Analysis</div>
        <div class="pro-card">
          <div class="pro-row">
            <div class="kv">Depth MA-5: <b>${depthDisplay(mean(lastN(state.depthSeries,5)))}</b></div>
            <div class="kv">Depth œÉ-30: <b>${stdev(lastN(state.depthSeries,30)).toFixed(2)}</b></div>
            <div class="kv">Temp MA-5: <b>${(mean(lastN(state.tempSeries,5))).toFixed(2)}¬∞C</b></div>
            <div class="kv">Temp œÉ-30: <b>${stdev(lastN(state.tempSeries,30)).toFixed(2)}¬∞C</b></div>
            <div class="kv">Slope MA-5: <b>${(mean(lastN(state.slopeSeries,5))).toFixed(2)}¬∞</b></div>
            <div class="kv">Slope œÉ-30: <b>${stdev(lastN(state.slopeSeries,30)).toFixed(2)}¬∞</b></div>
            <div class="kv">Proj Depth(10): <b>${depthDisplay(nextDepth)}</b></div>
            <div class="kv">Proj Temp(10): <b>${(nextTempC).toFixed(2)}¬∞C</b></div>
            <div class="kv">Risk Score: <b>${riskScore()}</b></div>
          </div>
        </div>
      </div>

      <div class="trend-card">
        <div class="trend-label">Raw Data</div>
        <div class="tr-table-wrap">
          <table class="tr-table">
            <thead><tr><th>Depth (${depthUnit})</th><th>Temp (${tempU})</th><th>Slope (¬∞)</th></tr></thead>
            <tbody id="rawBody"></tbody>
          </table>
        </div>
      </div>`:""}
    </div>
  `;

  drawSpark("c1", state.depthSeries.map(convertDepthForGraph));
  drawSpark("c2", state.tempSeries.map(convertTempForGraph));
  drawSpark("c3", state.slopeSeries);

  if(state.pro){
    const body=document.getElementById("rawBody");
    let html="";
    for(let i=state.depthSeries.length-1;i>=Math.max(0,state.depthSeries.length-200);i--){
      const d=depthDisplay(state.depthSeries[i]);
      const t=(localStorage.getItem("units")==="F")?((state.tempSeries[i]*9/5+32).toFixed(1)+" ¬∞F"):(state.tempSeries[i].toFixed(1)+" ¬∞C");
      const s=(state.slopeSeries[i]!==undefined? state.slopeSeries[i].toFixed(1):"‚Äî")+" ¬∞";
      html+=`<tr><td>${d}</td><td>${t}</td><td>${s}</td></tr>`;
    }
    body.innerHTML=html;
  }
}

/* Footer buttons */
function renderFooter(){
  const f=document.getElementById("footer");
  if(state.field){
    f.innerHTML = `
      <button class="btn" onclick="state.field=false;document.getElementById('fieldToggle').checked=false;document.getElementById('device').classList.remove('field');setMode('status')">Status</button>
      <button class="btn" onclick="swapFieldMetric()">Swap</button>
      <button class="btn" onclick="toggleSettings(true)">Settings</button>
    `;
  }else{
    f.innerHTML = `
      <button class="btn" onclick="setMode('status')">Status</button>
      <button class="btn" onclick="setMode('slope')">Slope</button>
      <button class="btn" onclick="setMode('trends')">Trends</button>
      <button class="btn" onclick="fakeTick()">Fake</button>
      <button class="btn" onclick="toggleSettings(true)">Settings</button>
    `;
  }
}

function swapFieldMetric(){
  state.fieldMetric = (state.fieldMetric==="slope")?"depth":"slope";
  render();
}

/* Reset PRO */
function resetPro(){
  state.pro = false;
  state.storm = false;
  state.stormRate = 0.0;

  localStorage.removeItem("units");
  localStorage.removeItem("depthUnits");
  localStorage.removeItem("av_theme");

  document.getElementById("proToggle").checked = false;
  document.getElementById("stormToggle").checked = false;
  document.getElementById("stormRate").value = "0.0";

  setTheme("glacier");
  localStorage.setItem("units","C");
  localStorage.setItem("depthUnits","cm");

  document.getElementById("device").classList.remove("pro");
  render();
}

/* Main render */
function render(){
  if(state.field){ renderField(); }
  else if(window.mode==="slope"){ renderSlope(); }
  else if(window.mode==="trends"){ renderTrends(); }
  else { renderStatus(); }

  renderFooter();
}

/* Sim */
function fakeTick(){
  state.depth+=(Math.random()-0.5)*2;
  state.trend+=(Math.random()-0.5)*0.4;
  state.tempC+=(Math.random()-0.5)*0.2;
  state.slope+=(Math.random()-0.5)*1.2;

  state.depthSeries.push(state.depth); if(state.depthSeries.length>200) state.depthSeries.shift();
  state.tempSeries.push(state.tempC);  if(state.tempSeries.length>200)  state.tempSeries.shift();
  state.slopeSeries.push(state.slope); if(state.slopeSeries.length>200) state.slopeSeries.shift();

  render();
}

/* Boot */
setInterval(()=>{state.dir=(state.dir+1)%8;document.getElementById("direction").textContent=DIR[state.dir];},3000);
for(let i=0;i<60;i++){
  state.depthSeries.push(110+(Math.sin(i/7)*2)+(Math.random()-0.5));
  state.tempSeries.push(-3+(Math.sin(i/10)*0.4)+(Math.random()-0.5)*0.2);
  state.slopeSeries.push(25+(Math.sin(i/8)*5)+(Math.random()-0.5)*3);
}
document.getElementById("unitsSelect").value=localStorage.getItem("units")||"C";
document.getElementById("depthUnits").value=localStorage.getItem("depthUnits")||"cm";
document.getElementById("proToggle").checked=state.pro;
document.getElementById("stormToggle").checked=state.storm;
document.getElementById("stormRate").value=state.stormRate.toFixed(1);
document.getElementById("fieldToggle").checked=state.field;

// Default to Status
setMode("status");

/* Resize charts on window resize */
window.addEventListener('resize', ()=>{
  if(window.mode==="trends" && !state.field){
    drawSpark("c1", state.depthSeries.map(convertDepthForGraph));
    drawSpark("c2", state.tempSeries.map(convertTempForGraph));
    drawSpark("c3", state.slopeSeries);
  }
});
</script>
</body>
</html>
